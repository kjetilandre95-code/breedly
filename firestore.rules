rules_version = '2';
// Breedly Firestore Security Rules
// Deploy with: firebase deploy --only firestore:rules
// Required so client requests keep working after Firestore "test mode" ends.

service cloud.firestore {
  match /databases/{database}/documents {

    // ——— User-scoped data: only the signed-in user can access their own document and subcollections
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ——— Breeding groups (kennels): only members can read/write; anyone authenticated can create (to create their kennel)
    match /breeding_groups/{kennelId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null
        && exists(/databases/$(database)/documents/breeding_groups/$(kennelId)/members/$(request.auth.uid));
    }
    // Members subcollection: can add yourself (when creating kennel) or if already a member
    match /breeding_groups/{kennelId}/members/{memberId} {
      allow read, write: if request.auth != null
        && (request.auth.uid == memberId
            || exists(/databases/$(database)/documents/breeding_groups/$(kennelId)/members/$(request.auth.uid)));
    }
    match /breeding_groups/{kennelId}/{subcollection}/{docId} {
      allow read, write: if request.auth != null
        && exists(/databases/$(database)/documents/breeding_groups/$(kennelId)/members/$(request.auth.uid));
    }

    // ——— Invitations: authenticated users can read (to look up by code) and write (to create/revoke)
    match /invitations/{inviteId} {
      allow read, write: if request.auth != null;
    }
  }
}
